<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>AdminLTE 2 | Build PC - Create</title>
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="stylesheet" href="../../bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
        <link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">
        <link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">
        <style>
            .component-block {
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                background: #f9f9f9;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .component-image {
                width: 100px;
                height: 100px;
                margin-right: 15px;
            }
            .d-flex {
                display: flex;
                align-items: center;
            }
            .component-meta, .component-price {
                margin-top: 5px;
            }
            .modal-overplay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .modal-content {
                background: white;
                padding: 20px;
                border-radius: 8px;
                width: 80%;
                max-width: 600px;
            }
            .modal-content {
                background: white;
                padding: 20px;
                border-radius: 8px;
                width: 90%;
                max-width: 900px;
                max-height: 80vh;
                overflow-y: auto;
            }

        </style>
    </head>

    <body class="hold-transition skin-blue sidebar-mini">
        <div class="wrapper">


            <!-- HEADER -->
            <header class="main-header">
                <!-- Logo -->
                <a href="${ctx}/AdminDashbordServlet" class="logo">
                    <span class="logo-mini"><b>A</b>LT</span>
                    <span class="logo-lg"><b>Admin</b>LTE</span>
                </a>
                <!-- Navbar -->
                <nav class="navbar navbar-static-top">
                    <button class="sidebar-toggle" data-toggle="offcanvas" aria-label="Toggle navigation">
                        <span class="sr-only">Toggle navigation</span>
                    </button>
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">
                            <!-- Messages -->
                            <li class="dropdown messages-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-envelope-o"></i>
                                    <span class="label label-success">4</span>
                                </a>
                                <!-- Message Dropdown Here -->
                            </li>
                            <!-- Notifications -->
                            <li class="dropdown notifications-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-bell-o"></i>
                                    <span class="label label-warning">10</span>
                                </a>
                                <!-- Notifications Dropdown Here -->
                            </li>
                            <!-- Tasks -->
                            <li class="dropdown tasks-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-flag-o"></i>
                                    <span class="label label-danger">9</span>
                                </a>
                                <!-- Tasks Dropdown Here -->
                            </li>
                            <!-- User Account -->
                            <li class="dropdown user user-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <img src="${ctx}/AdminLTE/dist/img/user2-160x160.jpg" class="user-image" alt="User">
                                    <span class="hidden-xs">Alexander Pierce</span>
                                </a>
                                <!-- User Menu Dropdown Here -->
                            </li>
                            <!-- Settings -->
                            <li>
                                <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <!-- SIDEBAR -->
            <aside class="main-sidebar">
                <section class="sidebar">
                    <div class="user-panel">
                        <div class="pull-left image">
                            <img src="/ComputerOnlineShop/AdminLTE/AdminPages/dist/img/user2-160x160.jpg" class="img-circle" alt="User">
                        </div>
                        <div class="pull-left info">
                            <p>Alexander Pierce</p>
                            <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
                        </div>
                    </div>
                    <form action="#" method="get" class="sidebar-form">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Search...">
                            <span class="input-group-btn">
                                <button type="submit" name="search" id="search-btn" class="btn btn-flat">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                        </div>
                    </form>
                    <ul class="sidebar-menu">
                        <li class="header">MAIN NAVIGATION</li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Brand</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/BrandAdmin"><i class="fa fa-circle-o"></i>View Brand</a></li>
                                <li><a href="/ComputerOnlineShop/BrandAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Brand</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Component</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/ComAdmin"><i class="fa fa-circle-o"></i>View Component</a></li>
                                <li><a href="/ComputerOnlineShop/ComAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Component</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>BraCom</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/BrandComAdmin"><i class="fa fa-circle-o"></i>View Bra-Com</a></li>
                                <li><a href="/ComputerOnlineShop/BrandComAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Brand-Com</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Category</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/CateAdmin"><i class="fa fa-circle-o"></i>View Category</a></li>
                                <li><a href="/ComputerOnlineShop/CateAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Category</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Import</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/Import"><i class="fa fa-circle-o"></i>View Import</a></li>
                                <li><a href="/ComputerOnlineShop/Import?service=insert"><i class="fa fa-circle-o"></i>Insert new Import</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Product</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/ProductAdmin"><i class="fa fa-circle-o"></i>View Product</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Warranty</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/WarrantyAdmin"><i class="fa fa-circle-o"></i>View Warranty</a></li>
                                <li><a href="/ComputerOnlineShop/WarrantyAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert Warranty</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Warranty Detail</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/WDA"><i class="fa fa-circle-o"></i>View Warranty Detail</a></li>
                                <li><a href="/ComputerOnlineShop/WDA?service=insert"><i class="fa fa-circle-o"></i>Insert Warranty Detail</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Order</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/OrderAdmin"><i class="fa fa-circle-o"></i>View Order</a></li>
                                <li><a href="/ComputerOnlineShop/OrderAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Order</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Feedback</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/FeedBackAdmin"><i class="fa fa-circle-o"></i>View Feedback</a></li>
                                <li><a href="/ComputerOnlineShop/FeedBackAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Feedback</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Blogs</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/bloga"><i class="fa fa-circle-o"></i>View Blog</a></li>
                                <li><a href="/ComputerOnlineShop/BlogAdmin&service=insert"><i class="fa fa-circle-o"></i>Insert new Blog</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-users"></i> <span>User Management</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/Admin/user?type=admin"><i class="fa fa-circle-o"></i>View Admins</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user?type=customer"><i class="fa fa-circle-o"></i>View Customers</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user?type=sale"><i class="fa fa-circle-o"></i>View Sales</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user?type=shipper"><i class="fa fa-circle-o"></i>View Shippers</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user/add"><i class="fa fa-circle-o"></i>Create new user</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>BuildPC</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/BuildPC_ListCate?service=list"><i class="fa fa-circle-o"></i> View PC</a></li>
                                <li><a href="/ComputerOnlineShop/AdminLTE/AdminPages/pages/forms/BuildPCAdmin.html"><i class="fa fa-circle-o"></i>Create new PC</a></li>
                            </ul>
                        </li>
                    </ul>
                </section>
            </aside>

            <!-- CONTENT -->
            <div class="content-wrapper">
                <section class="content-header">
                    <h1 class="text-center">Build Your PC</h1>
                </section>
                <div id="statusWrapper" class="form-group mt-3" style="display: none;">
                    <label for="statusSelect">Status:</label>
                    <select class="form-control" id="statusSelect">
                    </select>
                </div>

                <section class="content">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-7">
                                <!-- MainBoard -->
                                <div class="component-block" id="component-2">
                                    <div class="d-flex align-items-center">
                                        <img id="img-2" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" alt="MainBoard" class="component-image">
                                        <div>
                                            <strong>MainBoard</strong>
                                            <div id="meta-2" class="component-meta"></div>
                                            <div id="price-2" class="component-price"></div>
                                            <button id="remove-2" class="btn btn-sm btn-danger mt-2" style="display:none;" onclick="removeComponent(2)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(2, 'MainBoard')">Choose</button>
                                </div>

                                <!-- CPU -->
                                <div class="component-block" id="component-3">
                                    <div class="d-flex align-items-center">
                                        <img id="img-3" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/3.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/3.jpg" alt="CPU" class="component-image">
                                        <div>
                                            <strong>CPU</strong>
                                            <div id="meta-3" class="component-meta"></div>
                                            <div id="price-3" class="component-price"></div>
                                            <button id="remove-3" class="btn btn-sm btn-danger mt-3" style="display:none;" onclick="removeComponent(3)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(3, 'CPU')">Choose</button>
                                </div>

                                <!-- GPU -->
                                <div class="component-block" id="component-4">
                                    <div class="d-flex align-items-center">
                                        <img id="img-4" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/4.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/4.jpg" alt="GPU" class="component-image">
                                        <div>
                                            <strong>GPU</strong>
                                            <div id="meta-4" class="component-meta"></div>
                                            <div id="price-4" class="component-price"></div>
                                            <button id="remove-4" class="btn btn-sm btn-danger mt-4" style="display:none;" onclick="removeComponent(4)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(4, 'GPU')">Choose</button>
                                </div>

                                <!-- RAM -->
                                <div class="component-block" id="component-5">
                                    <div class="d-flex align-items-center">
                                        <img id="img-5" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/5.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/5.jpg" alt="RAM" class="component-image">
                                        <div>
                                            <strong>RAM</strong>
                                            <div id="meta-5" class="component-meta"></div>
                                            <div id="price-5" class="component-price"></div>
                                            <button id="remove-5" class="btn btn-sm btn-danger mt-5" style="display:none;" onclick="removeComponent(5)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(5, 'RAM')">Choose</button>
                                </div>

                                <!-- SSD -->
                                <div class="component-block" id="component-6">
                                    <div class="d-flex align-items-center">
                                        <img id="img-6" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/6.webp" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/6.webp" alt="SSD" class="component-image">
                                        <div>
                                            <strong>SSD</strong>
                                            <div id="meta-6" class="component-meta"></div>
                                            <div id="price-6" class="component-price"></div>
                                            <button id="remove-6" class="btn btn-sm btn-danger mt-6" style="display:none;" onclick="removeComponent(6)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(6, 'SSD')">Choose</button>
                                </div>

                                <!-- Case -->
                                <div class="component-block" id="component-7">
                                    <div class="d-flex align-items-center">
                                        <img id="img-7" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/7.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/7.jpg" alt="Case" class="component-image">
                                        <div>
                                            <strong>Case</strong>
                                            <div id="meta-7" class="component-meta"></div>
                                            <div id="price-7" class="component-price"></div>
                                            <button id="remove-7" class="btn btn-sm btn-danger mt-7" style="display:none;" onclick="removeComponent(7)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(7, 'Case')">Choose</button>
                                </div>

                            </div>
                            <div class="modal-overplay" id="customModal">
                                <div class="modal-content">
                                    <span class="close-btn" id="closeModal">&times;</span>
                                    <h4 id="modalTitle">SelectComponent</h4>
                                    <div id="modalBody">Loading...</div>
                                </div>
                            </div>
                            <div class="card border p-3 mt-3">
                                <h4 class="text-center mb-3">Tổng tiền</h4>
                                <h3 class="text-center text-success"><span id="totalPrice">0</span>₫</h3>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-success btn-lg" id="createPCBtn" onclick="submitBuildPC()">Tạo Build PC</button>
                            </div>
                        </div>
                </section>
            </div>
        </div>
        <script src="../../plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../../bootstrap/js/bootstrap.min.js"></script>
        <script src="../../dist/js/app.min.js"></script>
        <script>
                                    const ctx = "/ComputerOnlineShop";
                                    const modal = document.getElementById('customModal');
                                    const modalTitle = document.getElementById('modalTitle');
                                    const modalBody = document.getElementById('modalBody');
                                    const totalDisplay = document.getElementById('totalPrice');
                                    let selectedComponents = JSON.parse(localStorage.getItem("selectedComponents")) || {};
                                    let isCustomerPC = false;

                                    function openModal(componentid, componentName) {
                                        modal.style.display = 'flex';
                                        modalTitle.innerText = `Select ${componentName}`;
                                        modalBody.innerHTML = `<p>Loading...</p>`;
                                        document.body.style.overflow = "hidden";
                                        fetch(`${ctx}/BuildPC_ListCate?service=filter&componentID=${componentid}&ajax=true`)
                                                .then(res => res.text())
                                                .then(html => {
                                                    modalBody.innerHTML = html;
                                                    attachFilterFormHandler(componentid, componentName);
                                                    attachPaginationHandler(componentid, componentName);
                                                })
                                                .catch(() => {
                                                    modalBody.innerHTML = "<p style='color:red;'>Failed to load data</p>";
                                                });
                                    }

                                    document.getElementById('closeModal').addEventListener('click', () => {
                                        modal.style.display = 'none';
                                        document.body.style.overflow = "";
                                    });
                                    window.addEventListener('click', function (e) {
                                        if (modal.style.display === 'flex' && e.target === modal) {
                                            modal.style.display = 'none';
                                            document.body.style.overflow = "";
                                        }
                                    });

                                    window.addEventListener("DOMContentLoaded", function () {
                                        const urlParams = new URLSearchParams(window.location.search);
                                        const buildPCID = urlParams.get("buildPCID");
                                        const role = localStorage.getItem("userRole");

                                        if (!role || role.trim() === "") {
                                            alert("You need login to use this function!");
                                            window.location.href = `${ctx}/Login`;
                                            return;
                                        }
                                        const statusSelect = document.getElementById("statusSelect");
                                        const statusWrapper = document.getElementById("statusWrapper");
                                        const btn = document.getElementById("createPCBtn");
                                        // reload cate
                                        for (const compID of Object.keys(selectedComponents)) {
                                            const comp = selectedComponents[compID];
                                            selectProduct(
                                                    compID,
                                                    comp.categoryID,
                                                    comp.categoryName,
                                                    comp.brandName,
                                                    comp.price,
                                                    comp.imgURL,
                                                    comp.warrantyDesc || "",
                                                    comp.warrantyPrice || 0,
                                                    comp.warrantyDetailID || 0
                                                    );
                                        }
                                        if (buildPCID) {
                                            btn.innerText = "Update Build PC";
                                            btn.setAttribute("onclick", `submitUpdateBuildPC(${buildPCID})`);
                                            if (role === "Admin") {
                                                statusWrapper.style.display = "block";
                                                statusSelect.innerHTML = `
                                          <option value="1">On Sales</option>
                                                    <option value="2">Off</option>`;
                                             } else {
                                                statusWrapper.style.display = "none"; 
                                            }
                                            fetch(`${ctx}/BuildPC_ListCate?service=loadBuildPC&buildPCID=${buildPCID}`)
                                                    .then(res => res.text())
                                                    .then(text => {
                                                        const lines = text.trim().split("\n");
                                                        const firstLine = lines[0];
                                                        let creatorRole = "";

                                                        if (firstLine.startsWith("ROLE|")) {
                                                            creatorRole = firstLine.split("|")[1].trim();
                                                            if (creatorRole === "Customer") {
                                                                isCustomerPC = true;
                                                            }
                                                        }
                                                    
                                                        if (creatorRole === "Customer") {

                                                            document.querySelectorAll(".component-block").forEach(block => {
                                                                const chooseBtn = block.querySelector("button.btn-primary");
                                                                if (chooseBtn)
                                                                    chooseBtn.style.display = "none";
                                                            });


                                                            document.querySelectorAll('[id^="remove-"]').forEach(btn => {
                                                                btn.style.display = "none";
                                                            });
                                                        }



                                                        for (let i = 1; i < lines.length; i++) {
                                                            const line = lines[i];
                                                            const [componentID, categoryID, categoryName, brandName, price, imgURL, warrantyDesc, warrantyPrice, warrantyDetailID] = line.split("|");
                                                            updateComponentUI({
                                                                componentID: parseInt(componentID),
                                                                categoryID: parseInt(categoryID),
                                                                categoryName,
                                                                brandName,
                                                                price: parseFloat(price),
                                                                imgURL,
                                                                warrantyDesc: warrantyDesc || "",
                                                                warrantyPrice: parseFloat(warrantyPrice) || 0,
                                                                warrantyDetailID: parseInt(warrantyDetailID) || 0
                                                            });
                                                        }

                                                        localStorage.setItem("selectedComponents", JSON.stringify(selectedComponents));
                                                    });
                                        }
                                    });

                                    function attachFilterFormHandler(componentID, componentName) {
                                        const filterForm = modalBody.querySelector('#filterForm');
                                        if (filterForm) {
                                            filterForm.addEventListener('submit', function (e) {
                                                e.preventDefault();
                                                const url = filterForm.action + '?' + new URLSearchParams(new FormData(filterForm)).toString();
                                                fetch(url).then(res => res.text()).then(innerHtml => {
                                                    modalBody.innerHTML = innerHtml;
                                                    attachFilterFormHandler(componentID, componentName);
                                                    attachPaginationHandler(componentID, componentName);
                                                });
                                            });
                                        }
                                    }
                                    function attachPaginationHandler(componentID, componentName) {
                                        modalBody.querySelectorAll(".page-link").forEach(link => {
                                            link.addEventListener("click", function (e) {
                                                e.preventDefault();
                                                const page = parseInt(this.textContent.trim());
                                                if (!isNaN(page)) {
                                                    goToPage(page, componentID, componentName);
                                                }
                                            });
                                        });
                                    }
                                    
                                    function goToPage(page, componentID, componentName) {
                                        const filterForm = modalBody.querySelector('#filterForm');
                                        if (filterForm) {
                                            const formData = new FormData(filterForm);
                                            formData.set("page", page);
                                            const url = filterForm.action + "?" + new URLSearchParams(formData).toString();
                                            modalBody.innerHTML = "<p>Loading...</p>";
                                            fetch(url).then(res => res.text()).then(html => {
                                                modalBody.innerHTML = html;
                                                attachFilterFormHandler(componentID, componentName);
                                                attachPaginationHandler(componentID, componentName);
                                                modalBody.scrollTop = 0;
                                            });
                                        }
                                    }
                                    
                                    function selectProduct(componentID, categoryID, categoryName, brandName, price, imgURL, warrantyDesc = "", warrantyPrice = 0, warrantyDetailID = 0) {

                                        price = parseInt(price);
                                        if (isNaN(price))
                                            price = 0;

                                        warrantyPrice = parseInt(warrantyPrice);
                                        if (isNaN(warrantyPrice))
                                            warrantyPrice = 0;

                                        warrantyDetailID = parseInt(warrantyDetailID);
                                        if (isNaN(warrantyDetailID))
                                            warrantyDetailID = 0;

                                        document.getElementById(`meta-${componentID}`).innerText = `${categoryName} - ${brandName}`;
                                        document.getElementById(`price-${componentID}`).innerText = `Product: ${price.toLocaleString()}₫`;

                                        // Hiển thị bảo hành
                                        const warrantyText = warrantyDesc ? `Warranty: ${warrantyDesc} - ${warrantyPrice.toLocaleString()}₫` : "Warranty:Not choose";
                                        if (!document.getElementById(`warranty-${componentID}`)) {
                                            const warrantyDiv = document.createElement("div");
                                            warrantyDiv.id = `warranty-${componentID}`;
                                            warrantyDiv.classList.add("component-meta");
                                            document.getElementById(`price-${componentID}`).after(warrantyDiv);
                                        }
                                        document.getElementById(`warranty-${componentID}`).innerText = warrantyText;

                                        // Hiển thị tổng tiền riêng linh kiện
                                        const totalItem = price + warrantyPrice;
                                        if (!document.getElementById(`total-${componentID}`)) {
                                            const totalDiv = document.createElement("div");
                                            totalDiv.id = `total-${componentID}`;
                                            totalDiv.classList.add("component-total", "text-success");
                                            document.getElementById(`warranty-${componentID}`).after(totalDiv);
                                        }
                                        document.getElementById(`total-${componentID}`).innerText = `Total: ${totalItem.toLocaleString()}₫`;

                                        if (!isCustomerPC) {
                                            document.getElementById(`remove-${componentID}`).style.display = 'inline-block';
                                        }

                                        document.getElementById(`img-${componentID}`).src = `${ctx}/ShopPages/Pages/images/CatePicture/${imgURL}`;

                                        selectedComponents[componentID] = {
                                            categoryID: parseInt(categoryID),
                                            categoryName,
                                            brandName,
                                            price: parseInt(price) || 0,
                                            imgURL,
                                            warrantyDesc,
                                            warrantyPrice: parseInt(warrantyPrice) || 0,
                                            warrantyDetailID: parseInt(warrantyDetailID) || 0
                                        };

                                        localStorage.setItem("selectedComponents", JSON.stringify(selectedComponents));
                                        updateTotal();
                                        modal.style.display = 'none';
                                        document.body.style.overflow = "";
                                    }


                                    function updateTotal() {
                                        let total = 0;
                                        Object.values(selectedComponents).forEach(comp => {
                                            let price = parseInt(comp.price);
                                            let warrantyPrice = parseInt(comp.warrantyPrice);

                                            if (isNaN(price))
                                                price = 0;
                                            if (isNaN(warrantyPrice))
                                                warrantyPrice = 0;

                                            total += price + warrantyPrice;
                                        });
                                        totalDisplay.innerText = total.toLocaleString();
                                    }
                                    function updateComponentUI(item) {
                                        selectProduct(
                                                item.componentID,
                                                item.categoryID,
                                                item.categoryName,
                                                item.brandName,
                                                item.price,
                                                item.imgURL,
                                                item.warrantyDesc || "",
                                                item.warrantyPrice || 0,
                                                item.warrantyDetailID || 0
                                                );
                                    }
                                    function submitBuildPC() {
                                        const requiredComponents = [2, 3, 4, 5, 6, 7];
                                        const selectedIDs = Object.keys(selectedComponents).map(Number);
                                        const hasAllRequired = requiredComponents.every(id => selectedIDs.includes(id));

                                        if (!hasAllRequired) {
                                            alert("You need to choose 6 items: MainBoard, CPU, GPU, RAM, SSD, CASE.: MainBoard, CPU, GPU, RAM, SSD, CASE.");
                                            return;
                                        }

                                        const categoryIDs = requiredComponents.map(id => parseInt(selectedComponents[id].categoryID) || 0).join(",");
                                        const warrantyIDs = requiredComponents.map(id => parseInt(selectedComponents[id].warrantyDetailID) || 0).join(",");

                                        fetch(`${ctx}/BuildPC_ListCate?service=insert`, {
                                            method: "POST",
                                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                                            body: `categoryIDs=${encodeURIComponent(categoryIDs)}&warrantyIDs=${encodeURIComponent(warrantyIDs)}`
                                        })
                                                .then(res => {
                                                    if (res.status === 409)
                                                        throw new Error("Build PC have exist.");
                                                    if (!res.ok)
                                                        return res.text().then(msg => {
                                                            throw new Error(msg);
                                                        });
                                                    return res.text();
                                                })
                                                .then(() => {
                                                    alert("Build successful!");
                                                    localStorage.removeItem("selectedComponents");
                                                    window.location.href = `${ctx}/BuildPC_ListCate?service=list`;
                                                })
                                                .catch(err => {
                                                    alert("Lỗi: " + err.message);
                                                });
                                    }

                                    function submitUpdateBuildPC(buildPCID) {
                                        const requiredComponents = [2, 3, 4, 5, 6, 7];
                                        const selectedIDs = Object.keys(selectedComponents).map(Number);
                                        const hasAllRequired = requiredComponents.every(id => selectedIDs.includes(id));

                                        if (!hasAllRequired) {
                                            alert("You need to choose 6 items: MainBoard, CPU, GPU, RAM, SSD, CASE.");
                                            return;
                                        }
                                        const categoryIDs = requiredComponents.map(id => {
                                            const value = parseInt(selectedComponents[id]?.categoryID);
                                            return isNaN(value) ? 0 : value;
                                        }).join(",");

                                        const warrantyIDs = requiredComponents.map(id => {
                                            const value = parseInt(selectedComponents[id]?.warrantyDetailID);
                                            return isNaN(value) ? 0 : value;
                                        }).join(",");

                                        const statusSelect = document.getElementById('statusSelect');
                                        let status = 0;
                                        if (statusSelect && statusSelect.value) {
                                            status = parseInt(statusSelect.value);
                                        }

                                        if (isNaN(status)) {
                                            alert("Choose correct categoty.");
                                            return;
                                        }
                                        const role = localStorage.getItem("userRole") || "Customer";
                                        fetch(`${ctx}/BuildPC_ListCate?service=update`, {
                                            method: "POST",
                                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                                            body: `buildPCID=${buildPCID}&categoryIDs=${encodeURIComponent(categoryIDs)}&warrantyIDs=${encodeURIComponent(warrantyIDs)}&status=${status}&role=${role}`
                                        })
                                                .then(res => {
                                                    if (res.status === 409)
                                                        throw new Error("This PC have Exist.");
                                                    if (!res.ok)
                                                        return res.text().then(msg => {
                                                            throw new Error(msg);
                                                        });
                                                    return res.text();
                                                })
                                                .then(() => {
                                                    alert("Update success!");
                                                    localStorage.removeItem("selectedComponents");
                                                    window.location.href = `${ctx}/BuildPC_ListCate?service=list`;
                                                })
                                                .catch(err => {
                                                    alert("Lỗi: " + err.message);
                                                });
                                    }


                                    
                                    function chooseProductWithWarranty(componentID, realCategoryID, categoryName, brandName, price, imgURL, radioCategoryID) {
                                        const selectedRadio = document.querySelector(`input[name="warranty-${radioCategoryID}"]:checked`);

                                        let warrantyDetailID = 0;
                                        let warrantyDesc = "Không chọn";
                                        let warrantyPrice = 0;

                                        if (selectedRadio) {
                                            warrantyDetailID = parseInt(selectedRadio.value);
                                            const label = selectedRadio.nextElementSibling;

                                            const descSpan = label.querySelector(".warranty-desc");
                                            const priceSpan = label.querySelector(".warranty-price");

                                            if (descSpan) {
                                                warrantyDesc = descSpan.textContent.trim();
                                            }

                                            if (priceSpan) {
                                                const priceText = priceSpan.textContent.replace(/[^\d]/g, "");
                                                warrantyPrice = parseInt(priceText) || 0;
                                            }
                                        }

                                        selectProduct(componentID, realCategoryID, categoryName, brandName, price, imgURL, warrantyDesc, warrantyPrice, warrantyDetailID);
                                    }
                                      // xoa 
                                    function removeComponent(componentID) {
                                        document.getElementById(`meta-${componentID}`).innerText = "";
                                        document.getElementById(`price-${componentID}`).innerText = "";
                                        const warrantyDiv = document.getElementById(`warranty-${componentID}`);
                                        if (warrantyDiv) {
                                            warrantyDiv.remove();
                                        }
                                        const totalDiv = document.getElementById(`total-${componentID}`);
                                        if (totalDiv) {
                                            totalDiv.remove();
                                        }
                                        const img = document.getElementById(`img-${componentID}`);
                                        img.src = img.getAttribute("data-default")
                                        document.getElementById(`remove-${componentID}`).style.display = 'none';
                                        delete selectedComponents[componentID];
                                        localStorage.setItem("selectedComponents", JSON.stringify(selectedComponents));
                                        updateTotal();
                                    }


        </script>

    </body>
</html>